---
- name: Deploy dotfiles
  hosts: all

  vars:
    # Customize these if you want to
    dotfiles_path: "{{ ansible_env.HOME }}/dotfiles"

    # Necessary for a system that uses gui terminal applications
    # These fonts must be set inside the terminal app, which is a
    # setting that this playbook does NOT cover
    install_custom_font: true
    font_download_path: "{{ ansible_env.HOME }}/.fonts"

    # Change only in case the url changed
    fonts:
      - font_base_url: https://github.com/romkatv/powerlevel10k-media/raw/master
        font_files:
          - "MesloLGS NF Regular.ttf"
          - "MesloLGS NF Bold.ttf"
          - "MesloLGS NF Italic.ttf"
          - "MesloLGS NF Bold Italic.ttf"
      - font_base_url: https://github.com/JetBrains/JetBrainsMono/raw/master/fonts/ttf
        font_files:
          - "JetBrainsMono-Bold.ttf"
          - "JetBrainsMono-BoldItalic.ttf"
          - "JetBrainsMono-ExtraBold.ttf"
          - "JetBrainsMono-ExtraBoldItalic.ttf"
          - "JetBrainsMono-ExtraLight.ttf"
          - "JetBrainsMono-ExtraLightItalic.ttf"
          - "JetBrainsMono-Italic.ttf"
          - "JetBrainsMono-Light.ttf"
          - "JetBrainsMono-LightItalic.ttf"
          - "JetBrainsMono-Medium.ttf"
          - "JetBrainsMono-MediumItalic.ttf"
          - "JetBrainsMono-Regular.ttf"
          - "JetBrainsMono-SemiBold.ttf"
          - "JetBrainsMono-SemiBoldItalic.ttf"
          - "JetBrainsMono-Thin.ttf"
          - "JetBrainsMono-ThinItalic.ttf"
      - font_base_url: https://github.com/bBoxType/FiraSans/raw/master/Fira_Sans_4_3/Fonts/Fira_Sans_TTF_4301/Normal/Roman
        font_files:
          - "FiraSans-Bold.ttf"
          - "FiraSans-Book.ttf"
          - "FiraSans-Eight.ttf"
          - "FiraSans-ExtraBold.ttf"
          - "FiraSans-ExtraLight.ttf"
          - "FiraSans-Four.ttf"
          - "FiraSans-Hair.ttf"
          - "FiraSans-Heavy.ttf"
          - "FiraSans-Light.ttf"
          - "FiraSans-Medium.ttf"
          - "FiraSans-Regular.ttf"
          - "FiraSans-SemiBold.ttf"
          - "FiraSans-Thin.ttf"
          - "FiraSans-Two.ttf"
          - "FiraSans-Ultra.ttf"
          - "FiraSans-UltraLight.ttf"
      - font_base_url: https://github.com/bBoxType/FiraSans/raw/master/Fira_Sans_4_3/Fonts/Fira_Sans_TTF_4301/Normal/Italic
        font_files:
          - "FiraSans-BoldItalic.ttf"
          - "FiraSans-BookItalic.ttf"
          - "FiraSans-EightItalic.ttf"
          - "FiraSans-ExtraBoldItalic.ttf"
          - "FiraSans-ExtraLightItalic.ttf"
          - "FiraSans-FourItalic.ttf"
          - "FiraSans-HairItalic.ttf"
          - "FiraSans-HeavyItalic.ttf"
          - "FiraSans-Italic.ttf"
          - "FiraSans-LightItalic.ttf"
          - "FiraSans-MediumItalic.ttf"
          - "FiraSans-SemiBoldItalic.ttf"
          - "FiraSans-ThinItalic.ttf"
          - "FiraSans-TwoItalic.ttf"
          - "FiraSans-UltraItalic.ttf"
          - "FiraSans-UltraLightItalic.ttf"
      - font_base_url: https://github.com/cormullion/juliamono/raw/master
        font_files:
          - "JuliaMono-Black.ttf"
          - "JuliaMono-BlackItalic.ttf"
          - "JuliaMono-Bold.ttf"
          - "JuliaMono-BoldItalic.ttf"
          - "JuliaMono-BoldLatin.ttf"
          - "JuliaMono-ExtraBold.ttf"
          - "JuliaMono-ExtraBoldItalic.ttf"
          - "JuliaMono-Light.ttf"
          - "JuliaMono-LightItalic.ttf"
          - "JuliaMono-Medium.ttf"
          - "JuliaMono-MediumItalic.ttf"
          - "JuliaMono-Regular.ttf"
          - "JuliaMono-RegularItalic.ttf"
          - "JuliaMono-RegularLatin.ttf"
          - "JuliaMono-SemiBold.ttf"
          - "JuliaMono-SemiBoldItalic.ttf"
    home: "{{ lookup('env', 'HOME') }}"

  tasks:
    - name: See if dotfiles exists
      ansible.builtin.stat:
        path: "{{ dotfiles_path }}"
      register: dotfiles_exists

    # PACKAGE INSTALLATION
    - name: Install necessary packages
      become: true
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      loop: ["zsh", "curl"]
    # END PACKAGE INSTALLATION

    # OH MY ZSH
    - name: Check oh my zsh installation
      ansible.builtin.stat:
        path: "{{ home }}/.oh-my-zsh"
      register: omz_home

    - name: Install oh my zsh
      ansible.builtin.command:
        cmd: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
      when: not omz_home.stat.exists
      register: omz_install
    # END OH MY ZSH

    # ZSH THEME
    - name: Get powerlevel10k theme
      ansible.builtin.git:
        repo: https://github.com/romkatv/powerlevel10k.git
        depth: 1
        dest: "{{ home }}/.oh-my-zsh/custom/themes/powerlevel10k"
        version: master
    # END ZSH THEME

    # ZSH USER PLUGINS
    - name: Get zsh-users plugins
      ansible.builtin.git:
        repo: "git@github.com:zsh-users/{{ item }}.git"
        dest: "{{ home }}/.oh-my-zsh/custom/plugins/{{ item }}"
        version: master
      loop:
        - zsh-autosuggestions
        - zsh-syntax-highlighting
        - zsh-completions

    # END ZSH USER PLUGINS

    # CONFIGURATION LINKS
    - name: Link configuration files
      ansible.builtin.file:
        state: link
        src: "{{ item.src }}"
        path: "{{ item.path }}"
      loop:
        - src: "{{ home }}/dotfiles/zshrc"
          path: "{{ home }}/.zshrc"
        - src: "{{ home }}/dotfiles/zsh"
          path: "{{ home }}/.zsh"
        - src: "{{ home }}/dotfiles/gitconfig"
          path: "{{ home }}/.gitconfig"
        - src: "{{ home }}/dotfiles/zsh/configs/p10k.zsh"
          path: "{{ home }}/.p10k.zsh"
    # END CONFIGURATION LINKS


    # SHELL CONFIGURATION
    - name: Set zsh as shell
      become: true
      ansible.builtin.user:
        name: "{{ ansible_env.USER }}"
        shell: /bin/zsh
    # END SHELL CONFIGURATION

    # FONT INSTALLATION
    - name: Install custom fonts
      block:
        - name: Create download folder
          ansible.builtin.file:
            path: "{{ font_download_path }}"
            mode: 0755
            state: directory

        - name: Download the files
          ansible.builtin.get_url:
            url: "{{ item.0.font_base_url }}/{{ item.1 | urlencode() }}"
            dest: "{{ font_download_path }}/{{ item.1 }}"
            mode: 0644
          loop: "{{ fonts | subelements('font_files') }}"
          loop_control:
            label: "{{ item.1 }}"
      when: install_custom_font
      tags: ["fonts"]
    # END FONT INSTALLATION
